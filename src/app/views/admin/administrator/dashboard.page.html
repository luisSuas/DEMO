<ion-header>
  <ion-toolbar color="primary">
    <ion-title class="ion-text-center">{{ name }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-grid>

    <!-- MAIN METRICS -->
    <ion-row>
      <ion-col size="12" size-md="6" size-lg="4">
        <ion-card color="light">
          <ion-card-content class="dashboard-card-content ion-text-center">
            <ion-icon class="dashboard-icon home-workers" [icon]="'home-outline'" size="large"></ion-icon>
            <h2>Home Workers</h2>
            <p>{{ homeWorkersCount }} home workers</p>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" size-md="6" size-lg="4">
        <ion-card color="light">
          <ion-card-content class="dashboard-card-content ion-text-center">
            <ion-icon class="dashboard-icon workers" [icon]="'people-outline'" size="large"></ion-icon>
            <h2>Workers</h2>
            <p>{{ workersCount }} workers</p>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" size-md="6" size-lg="4">
        <ion-card color="light">
          <ion-card-content class="dashboard-card-content ion-text-center">
            <ion-icon class="dashboard-icon orders" [icon]="'document-text-outline'" size="large"></ion-icon>
            <h2>Orders</h2>
            <p>{{ ordersCount }} orders</p>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- TRACKING PANEL -->
    <ion-row>
      <ion-col size="12">
        <ion-card color="light" id="tracking-panel">
          <ion-card-header>
            <ion-card-title>Tracking Panel</ion-card-title>
          </ion-card-header>
          <ion-card-content>

            <!-- Area Filter -->
            <ion-segment [(ngModel)]="selectedArea" (ionChange)="onAreaChanged($event)">
              <ion-segment-button value="all">All</ion-segment-button>
              <ion-segment-button value="hotel">Hotel</ion-segment-button>
              <ion-segment-button value="casino">Casino</ion-segment-button>
            </ion-segment>

            <!-- Time Filter -->
            <ion-segment [(ngModel)]="selectedSegment" (ionChange)="onSegmentChanged($event)" style="margin-top: 8px;">
              <ion-segment-button value="daily">Daily</ion-segment-button>
              <ion-segment-button value="weekly">Weekly</ion-segment-button>
              <ion-segment-button value="monthly">Monthly</ion-segment-button>
            </ion-segment>

            <!-- Most Requested Jobs List -->
            <ion-list style="margin-top: 16px;">
              <ion-list-header>
                <ion-label>Most Requested Jobs ({{ selectedSegment | titlecase }})</ion-label>
              </ion-list-header>
              <ion-item *ngFor="let job of currentPopularJobs">
                <ion-label>{{ job.job }}</ion-label>
                <ion-progress-bar
                  [color]="getJobHexColor(job.category)"
                  [value]="job.count / maxJobCount"
                  style="height: 20px; border-radius: 10px; margin: 0 10px;">
                </ion-progress-bar>
                <ion-badge slot="end" color="primary">{{ job.count }}</ion-badge>
              </ion-item>
            </ion-list>

            <!-- Popular Jobs Chart -->
            <div class="popular-jobs-chart-container" style="max-width: 100%; margin-top: 12px;">
              <canvas id="popularJobsChart" #popularJobsChart style="width: 100%; height: 300px;"></canvas>
            </div>

          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- RANKING AND GRAPHS -->
    <ion-row>
      <ion-col size="12" size-md="4">
        <ion-card color="light">
          <ion-card-header>
            <ion-card-title>Top 5 Workers</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list>
              <ion-item *ngFor="let worker of topWorkers; let i = index">
                <ion-icon [icon]="'trophy-outline'" slot="start" color="warning"></ion-icon>
                <ion-label>
                  <h2>{{ i + 1 }}. {{ worker.name }}</h2>
                  <p>Orders: {{ worker.points }}</p>
                </ion-label>
                <ion-badge color="primary">{{ i + 1 }}</ion-badge>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" size-md="4">
        <ion-card color="light">
          <ion-card-header>
            <ion-card-title>Chart - Last 7 Days</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div class="orders-chart-container">
              <canvas id="ordersChart" #ordersChart></canvas>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>

      <ion-col size="12" size-md="4">
        <ion-card color="light">
          <ion-card-header>
            <ion-card-title>Most Requested Jobs</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <div style="max-width: 350px; margin: 0 auto;">
              <canvas
                id="mostRequestedChart"
                #mostRequestedChart
                style="width: 100%; aspect-ratio: 1 / 1; max-height: 300px;">
              </canvas>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

    <!-- WORKER STATUS PANEL + HISTORY AS CARDS -->
    <ion-row>
      <ion-col size="12">
        <ion-segment [(ngModel)]="selectedWorkerSegment" (ionChange)="onWorkerSegmentChanged($event)">
          <ion-segment-button value="daily">Daily</ion-segment-button>
          <ion-segment-button value="weekly">Weekly</ion-segment-button>
          <ion-segment-button value="monthly">Monthly</ion-segment-button>
        </ion-segment>
      </ion-col>
    </ion-row>

    <ion-row>
      <ion-col size="12" size-md="4" *ngFor="let worker of workersActivity">
        <ion-card class="worker-card" color="light" [ngStyle]="{ 'box-shadow': getCardShadow(worker) }">
          <ion-card-header>
            <ion-card-title class="ion-text-center">{{ worker.name }}</ion-card-title>
            <ion-badge [color]="getStatusColor(worker.status)" class="worker-status-badge">
              {{ getStatusText(worker.status) }}
            </ion-badge>
          </ion-card-header>

          <ion-card-content>
            <!-- Barra de progreso personalizada -->
            <div class="progress-container">
              <div
                class="progress-bar"
                [ngStyle]="{
                  width: getProgressBarWidth(worker),
                  'background-color': getProgressBarColor(worker),
                  border: getProgressBarBorder(worker)
                }"
              ></div>
            </div>
            <small>Progress: {{ getProgressBarWidth(worker) }}</small>

            <!-- Mostrar actividad actual -->
            <p><strong>Current Task:</strong> {{ worker.task }}</p>

            <p><strong>Total Hours:</strong> {{ getTotalHours(worker) }} hours</p>
            <p><strong>Total Paid:</strong> {{ getTotalPayment(worker) }}</p>

            <!-- Activity History -->
            <ion-list>
              <ion-list-header>
                <ion-label><strong>Activity History</strong></ion-label>
              </ion-list-header>
              <ion-item *ngFor="let task of worker.history">
                <ion-label>
                  <h3>{{ task.task }}</h3>
                  <p>Time: {{ task.duration }}h | Pay: {{ task.payment }}</p>
                </ion-label>
                <ion-note slot="end">{{ task.date }}</ion-note>
              </ion-item>
            </ion-list>

            <!-- NUEVO: Status Log -->
            <ion-accordion-group>
              <ion-accordion>
                <ion-item slot="header">
                  <ion-icon name="calendar-outline" slot="start"></ion-icon>
                  <ion-label>Status Log</ion-label>
                </ion-item>
                <div slot="content" class="ion-padding">
                  <ion-list *ngIf="worker.statusLog?.length">
                    <ion-item *ngFor="let log of worker.statusLog">
                      <ion-label>
                        <h3>{{ log.state }}</h3>
                        <p *ngIf="log.date"><ion-icon name="time-outline"></ion-icon> {{ log.date }}</p>
                        <p *ngIf="log.payment"><ion-icon name="cash-outline"></ion-icon> {{ log.payment }}</p>
                        <div *ngIf="log.images?.length" class="status-images">
                          <ion-img *ngFor="let img of log.images" [src]="img" class="thumb"></ion-img>
                        </div>
                        <div *ngIf="log.rating">
                          <ion-icon 
                            *ngFor="let _ of getStarsArray(log.rating)" 
                            name="star" 
                            class="star">
                          </ion-icon>
                        </div>
                      </ion-label>
                    </ion-item>
                  </ion-list>
                  <p *ngIf="!worker.statusLog?.length">No status steps recorded.</p>
                </div>
              </ion-accordion>
            </ion-accordion-group>

          </ion-card-content>
        </ion-card>
      </ion-col>
    </ion-row>

  </ion-grid>
</ion-content>
